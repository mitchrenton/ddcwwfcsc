name: Deploy

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set deployment paths
        id: vars
        run: |
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "plugin_path=wp-content/plugins/ddcwwfcsc/" >> $GITHUB_OUTPUT
            echo "theme_path=wp-content/themes/ddcwwfcsc-theme/" >> $GITHUB_OUTPUT
          else
            echo "plugin_path=ddcwwfcsc_staging/wp-content/plugins/ddcwwfcsc/" >> $GITHUB_OUTPUT
            echo "theme_path=ddcwwfcsc_staging/wp-content/themes/ddcwwfcsc-theme/" >> $GITHUB_OUTPUT
          fi

      - name: Install lftp
        run: sudo apt-get install -y lftp

      - name: Deploy plugin
        run: |
          lftp -c "
            set ftp:ssl-allow no;
            set ftp:passive-mode yes;
            set net:timeout 30;
            set net:max-retries 2;
            set mirror:parallel-transfer-count 1;
            open -u ${{ secrets.SFTP_USERNAME }},${{ secrets.SFTP_PASSWORD }} ftp://${{ secrets.SFTP_HOST }};
            mirror -R --verbose wp-content/plugins/ddcwwfcsc/ ${{ steps.vars.outputs.plugin_path }}
          "

      - name: Deploy theme
        run: |
          lftp -c "
            set ftp:ssl-allow no;
            set ftp:passive-mode yes;
            set net:timeout 30;
            set net:max-retries 2;
            set mirror:parallel-transfer-count 1;
            open -u ${{ secrets.SFTP_USERNAME }},${{ secrets.SFTP_PASSWORD }} ftp://${{ secrets.SFTP_HOST }};
            mirror -R --verbose wp-content/themes/ddcwwfcsc-theme/ ${{ steps.vars.outputs.theme_path }}
          "
